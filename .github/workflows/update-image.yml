name: Auto Update on Laravel Docker Changes

on:
  repository_dispatch:
    types: [laravel-docker-updated]
  workflow_dispatch:
    inputs:
      ecr_image:
        description: 'Full ECR image URI (e.g., 123456.dkr.ecr.us-east-1.amazonaws.com/laravel-app:tag)'
        required: true

jobs:
  update-deployment:
    name: Update Deployment Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image details
        id: image
        run: |
          if [ -n "${{ github.event.inputs.ecr_image }}" ]; then
            IMAGE="${{ github.event.inputs.ecr_image }}"
          else
            IMAGE="${{ github.event.client_payload.image }}"
          fi
          
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Using image: ${IMAGE}"

      - name: Update Laravel and Worker deployments
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          
          # Update laravel-deployment.yaml
          sed -i "s|image:.*|image: ${IMAGE}|g" base/laravel/laravel-deployment.yaml
          
          # Update laravel-worker-deployment.yaml  
          sed -i "s|image:.*|image: ${IMAGE}|g" base/laravel/laravel-worker-deployment.yaml
          
          echo "âœ… Updated deployment files with: ${IMAGE}"

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add base/laravel/laravel-deployment.yaml
          git add base/laravel/laravel-worker-deployment.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update Laravel image to ${{ steps.image.outputs.image }}"
            git push
          fi
